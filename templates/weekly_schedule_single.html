<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Schedule - {{ user.username }} - TimeKpr webUI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="dashboard-body">
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>Weekly Schedule - {{ user.username }}</h1>
            <div class="user-controls">
                <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-back">← Back to Dashboard</a>
                <a href="{{ url_for('admin') }}" class="btn btn-sm btn-admin">Admin</a>
                <a href="{{ url_for('settings') }}" class="btn btn-sm btn-settings">Settings</a>
                <a href="{{ url_for('logout') }}" class="btn btn-sm btn-logout">Logout</a>
            </div>
        </header>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="single-user-schedule">
            <div class="user-info-header">
                <div class="user-details">
                    <h2>{{ user.username }}</h2>
                    <div class="user-location">{{ user.system_ip }}</div>
                    <div class="user-status">
                        {% if user.weekly_schedule and not user.weekly_schedule.is_synced %}
                            <div class="sync-status unsynced" title="Changes not yet synced to remote system">
                                ⚠ Schedule Not Synced
                            </div>
                        {% elif user.weekly_schedule and user.weekly_schedule.is_synced %}
                            <div class="sync-status synced" title="Schedule synchronized with remote system">
                                ✓ Schedule Synced
                            </div>
                        {% else %}
                            <div class="sync-status neutral">
                                No Schedule Set
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="schedule-form-container">
                <form id="schedule-form" method="POST" action="{{ url_for('update_weekly_schedule') }}">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    
                    <div class="schedule-header">
                        <h3>Weekly Time Limits (hours per day)</h3>
                        <div class="current-schedule-summary">
                            {% if user.weekly_schedule %}
                                {% set schedule = user.weekly_schedule.get_schedule_dict() %}
                                <div class="schedule-summary">
                                    <h4>Current Schedule</h4>
                                    <div class="schedule-overview">
                                        <div class="schedule-week-row">
                                            <div class="schedule-weekdays">
                                                <h5>Weekdays</h5>
                                                <div class="day-badges">
                                                    <span class="day-badge">Mon: {{ schedule['monday'] }}h</span>
                                                    <span class="day-badge">Tue: {{ schedule['tuesday'] }}h</span>
                                                    <span class="day-badge">Wed: {{ schedule['wednesday'] }}h</span>
                                                    <span class="day-badge">Thu: {{ schedule['thursday'] }}h</span>
                                                    <span class="day-badge">Fri: {{ schedule['friday'] }}h</span>
                                                </div>
                                            </div>
                                            <div class="schedule-weekends">
                                                <h5>Weekends</h5>
                                                <div class="day-badges">
                                                    <span class="day-badge weekend">Sat: {{ schedule['saturday'] }}h</span>
                                                    <span class="day-badge weekend">Sun: {{ schedule['sunday'] }}h</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="schedule-totals">
                                            {% set total_week = schedule['monday'] + schedule['tuesday'] + schedule['wednesday'] + schedule['thursday'] + schedule['friday'] %}
                                            {% set total_weekend = schedule['saturday'] + schedule['sunday'] %}
                                            {% set total_all = total_week + total_weekend %}
                                            <div class="total-badge">
                                                <strong>Total: {{ total_all }}h/week</strong>
                                                <small>({{ total_week }}h weekdays + {{ total_weekend }}h weekend)</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="weekday-controls">
                            <div class="bulk-controls">
                                <label>Quick Set Hours:</label>
                                <div class="time-input-group">
                                    <button type="button" class="btn-time-adjust btn-minus" onclick="adjustBulkTime(-0.25)">−</button>
                                    <input type="number" id="bulk-hours" min="0" max="24" step="0.25" placeholder="Hours" class="schedule-input">
                                    <button type="button" class="btn-time-adjust btn-plus" onclick="adjustBulkTime(0.25)">+</button>
                                </div>
                                <div class="bulk-buttons">
                                    <button type="button" class="btn btn-mobile btn-set-weekdays" onclick="setWeekdayHours()">Apply to Weekdays</button>
                                    <button type="button" class="btn btn-mobile btn-set-all" onclick="setAllDaysHours()">Apply to All Days</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="schedule-grid">
                        <div class="schedule-day">
                            <label for="monday">Monday:</label>
                            <div class="time-input-group">
                                <button type="button" class="btn-time-adjust btn-minus" onclick="adjustDayTime('monday', -0.25)">−</button>
                                <input type="number" 
                                       id="monday" 
                                       name="monday" 
                                       min="0" 
                                       max="24" 
                                       step="0.25"
                                       value="{% if user.weekly_schedule %}{{ user.weekly_schedule.get_schedule_dict()['monday'] }}{% else %}0{% endif %}"
                                       class="schedule-input">
                                <button type="button" class="btn-time-adjust btn-plus" onclick="adjustDayTime('monday', 0.25)">+</button>
                            </div>
                            <span class="hours-label">hours</span>
                        </div>
                        
                        <div class="schedule-day">
                            <label for="tuesday">Tuesday:</label>
                            <div class="time-input-group">
                                <button type="button" class="btn-time-adjust btn-minus" onclick="adjustDayTime('tuesday', -0.25)">−</button>
                                <input type="number" 
                                       id="tuesday" 
                                       name="tuesday" 
                                       min="0" 
                                       max="24" 
                                       step="0.25"
                                       value="{% if user.weekly_schedule %}{{ user.weekly_schedule.get_schedule_dict()['tuesday'] }}{% else %}0{% endif %}"
                                       class="schedule-input">
                                <button type="button" class="btn-time-adjust btn-plus" onclick="adjustDayTime('tuesday', 0.25)">+</button>
                            </div>
                            <span class="hours-label">hours</span>
                        </div>
                        
                        <div class="schedule-day">
                            <label for="wednesday">Wednesday:</label>
                            <div class="time-input-group">
                                <button type="button" class="btn-time-adjust btn-minus" onclick="adjustDayTime('wednesday', -0.25)">−</button>
                                <input type="number" 
                                       id="wednesday" 
                                       name="wednesday" 
                                       min="0" 
                                       max="24" 
                                       step="0.25"
                                       value="{% if user.weekly_schedule %}{{ user.weekly_schedule.get_schedule_dict()['wednesday'] }}{% else %}0{% endif %}"
                                       class="schedule-input">
                                <button type="button" class="btn-time-adjust btn-plus" onclick="adjustDayTime('wednesday', 0.25)">+</button>
                            </div>
                            <span class="hours-label">hours</span>
                        </div>
                        
                        <div class="schedule-day">
                            <label for="thursday">Thursday:</label>
                            <div class="time-input-group">
                                <button type="button" class="btn-time-adjust btn-minus" onclick="adjustDayTime('thursday', -0.25)">−</button>
                                <input type="number" 
                                       id="thursday" 
                                       name="thursday" 
                                       min="0" 
                                       max="24" 
                                       step="0.25"
                                       value="{% if user.weekly_schedule %}{{ user.weekly_schedule.get_schedule_dict()['thursday'] }}{% else %}0{% endif %}"
                                       class="schedule-input">
                                <button type="button" class="btn-time-adjust btn-plus" onclick="adjustDayTime('thursday', 0.25)">+</button>
                            </div>
                            <span class="hours-label">hours</span>
                        </div>
                        
                        <div class="schedule-day">
                            <label for="friday">Friday:</label>
                            <div class="time-input-group">
                                <button type="button" class="btn-time-adjust btn-minus" onclick="adjustDayTime('friday', -0.25)">−</button>
                                <input type="number" 
                                       id="friday" 
                                       name="friday" 
                                       min="0" 
                                       max="24" 
                                       step="0.25"
                                       value="{% if user.weekly_schedule %}{{ user.weekly_schedule.get_schedule_dict()['friday'] }}{% else %}0{% endif %}"
                                       class="schedule-input">
                                <button type="button" class="btn-time-adjust btn-plus" onclick="adjustDayTime('friday', 0.25)">+</button>
                            </div>
                            <span class="hours-label">hours</span>
                        </div>
                        
                        <div class="schedule-day">
                            <label for="saturday">Saturday:</label>
                            <div class="time-input-group">
                                <button type="button" class="btn-time-adjust btn-minus" onclick="adjustDayTime('saturday', -0.25)">−</button>
                                <input type="number" 
                                       id="saturday" 
                                       name="saturday" 
                                       min="0" 
                                       max="24" 
                                       step="0.25"
                                       value="{% if user.weekly_schedule %}{{ user.weekly_schedule.get_schedule_dict()['saturday'] }}{% else %}0{% endif %}"
                                       class="schedule-input">
                                <button type="button" class="btn-time-adjust btn-plus" onclick="adjustDayTime('saturday', 0.25)">+</button>
                            </div>
                            <span class="hours-label">hours</span>
                        </div>
                        
                        <div class="schedule-day">
                            <label for="sunday">Sunday:</label>
                            <div class="time-input-group">
                                <button type="button" class="btn-time-adjust btn-minus" onclick="adjustDayTime('sunday', -0.25)">−</button>
                                <input type="number" 
                                       id="sunday" 
                                       name="sunday" 
                                       min="0" 
                                       max="24" 
                                       step="0.25"
                                       value="{% if user.weekly_schedule %}{{ user.weekly_schedule.get_schedule_dict()['sunday'] }}{% else %}0{% endif %}"
                                       class="schedule-input">
                                <button type="button" class="btn-time-adjust btn-plus" onclick="adjustDayTime('sunday', 0.25)">+</button>
                            </div>
                            <span class="hours-label">hours</span>
                        </div>
                    </div>
                    
                    <div class="schedule-actions">
                        <button type="submit" class="btn btn-confirm">Save Schedule</button>
                        <button type="button" class="btn btn-cancel" onclick="resetScheduleForm()">Reset</button>
                    </div>
                    
                    {% if user.weekly_schedule %}
                        <div class="schedule-info">
                            <div class="info-item">
                                <span class="info-label">Last Modified:</span>
                                <span class="info-value">
                                    {% if user.weekly_schedule.last_modified %}
                                        {{ user.weekly_schedule.last_modified.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        Never
                                    {% endif %}
                                </span>
                            </div>
                            {% if user.weekly_schedule.last_synced %}
                                <div class="info-item">
                                    <span class="info-label">Last Synced:</span>
                                    <span class="info-value">
                                        {{ user.weekly_schedule.last_synced.strftime('%Y-%m-%d %H:%M') }}
                                    </span>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
    
    <script>
        function setWeekdayHours() {
            const bulkHours = document.getElementById('bulk-hours').value;
            if (!bulkHours) {
                alert('Please enter hours for weekdays');
                return;
            }
            
            // Set Monday through Friday
            const weekdays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            weekdays.forEach(day => {
                document.getElementById(day).value = bulkHours;
            });
        }
        
        function setAllDaysHours() {
            const bulkHours = document.getElementById('bulk-hours').value;
            if (!bulkHours) {
                alert('Please enter hours for all days');
                return;
            }
            
            // Set all days
            const allDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            allDays.forEach(day => {
                document.getElementById(day).value = bulkHours;
            });
        }
        
        function adjustDayTime(dayId, adjustment) {
            const input = document.getElementById(dayId);
            let currentValue = parseFloat(input.value) || 0;
            let newValue = currentValue + adjustment;
            
            // Ensure within bounds
            if (newValue < 0) newValue = 0;
            if (newValue > 24) newValue = 24;
            
            input.value = newValue;
        }
        
        function adjustBulkTime(adjustment) {
            const input = document.getElementById('bulk-hours');
            let currentValue = parseFloat(input.value) || 0;
            let newValue = currentValue + adjustment;
            
            // Ensure within bounds
            if (newValue < 0) newValue = 0;
            if (newValue > 24) newValue = 24;
            
            input.value = newValue;
        }
        
        function resetScheduleForm() {
            if (confirm('Are you sure you want to reset the schedule to the last saved values?')) {
                // Reload the page to restore original values
                window.location.reload();
            }
        }
        
        // Function to update sync status
        function updateSyncStatus() {
            fetch(`/api/schedule-sync-status/{{ user.id }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const syncStatusElement = document.querySelector('.sync-status');
                        const currentScheduleSummary = document.querySelector('.current-schedule-summary');
                        
                        if (syncStatusElement) {
                            // Update sync status
                            syncStatusElement.className = 'sync-status ' + (data.is_synced ? 'synced' : 'unsynced');
                            
                            if (data.is_synced) {
                                syncStatusElement.innerHTML = '✓ Schedule Synced';
                                syncStatusElement.title = 'Schedule synchronized with remote system';
                            } else {
                                syncStatusElement.innerHTML = '⚠ Schedule Not Synced';
                                syncStatusElement.title = 'Changes not yet synced to remote system';
                            }
                        }
                        
                        // Update the current schedule summary if it changed
                        if (data.schedule && currentScheduleSummary) {
                            const scheduleQuickView = currentScheduleSummary.querySelector('.schedule-quick-view');
                            if (scheduleQuickView) {
                                const scheduleText = `Mon: ${data.schedule.monday}h, Tue: ${data.schedule.tuesday}h, Wed: ${data.schedule.wednesday}h, Thu: ${data.schedule.thursday}h, Fri: ${data.schedule.friday}h, Sat: ${data.schedule.saturday}h, Sun: ${data.schedule.sunday}h`;
                                scheduleQuickView.textContent = scheduleText;
                            }
                        }
                        
                        // Update last synced info if available
                        if (data.last_synced) {
                            const lastSyncedElement = document.querySelector('.schedule-info .info-item:last-child .info-value');
                            if (lastSyncedElement) {
                                lastSyncedElement.textContent = data.last_synced;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching sync status:', error);
                });
        }
        
        // Add form change detection to show unsaved changes warning
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('schedule-form');
            const inputs = form.querySelectorAll('input[type="number"]');
            let originalValues = {};
            
            // Store original values
            inputs.forEach(input => {
                originalValues[input.name] = input.value;
            });
            
            // Track changes
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    let hasChanges = false;
                    inputs.forEach(inp => {
                        if (inp.value !== originalValues[inp.name]) {
                            hasChanges = true;
                        }
                    });
                    
                    // Update form appearance based on changes
                    if (hasChanges) {
                        form.classList.add('has-changes');
                    } else {
                        form.classList.remove('has-changes');
                    }
                });
            });
            
            // Start checking sync status every 5 seconds
            updateSyncStatus();
            setInterval(updateSyncStatus, 5000);
        });
    </script>
</body>
</html>