<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Schedule - {{ user.username }} - TimeKpr webUI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <style>
        .schedule-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-6);
        }
        
        .schedule-overview {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }
        
        .schedule-controls {
            display: flex;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
        }
        
        .quick-control {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            background: var(--bg-secondary);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-primary);
        }
        
        .quick-control label {
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .quick-input {
            width: 80px;
            padding: var(--space-2);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            text-align: center;
        }
        
        .schedule-table {
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            overflow: hidden;
        }
        
        .schedule-header-row {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-primary);
            padding: var(--space-4) var(--space-6);
            display: grid;
            grid-template-columns: 120px 1fr 1fr;
            gap: var(--space-4);
            align-items: center;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .schedule-row {
            padding: var(--space-4) var(--space-6);
            display: grid;
            grid-template-columns: 120px 1fr 1fr;
            gap: var(--space-4);
            align-items: center;
            border-bottom: 1px solid var(--border-primary);
            transition: background-color var(--transition-fast);
        }
        
        .schedule-row:hover {
            background: var(--bg-secondary);
        }
        
        .schedule-row:last-child {
            border-bottom: none;
        }
        
        .day-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--font-size-base);
        }
        
        .weekend .day-name {
            color: var(--warning);
        }
        
        .time-section {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .time-controls {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .time-input {
            width: 80px;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            text-align: center;
            font-size: var(--font-size-base);
            font-weight: 500;
        }
        
        .time-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
        }
        
        .time-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border-primary);
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            font-size: var(--font-size-base);
            transition: all var(--transition-fast);
        }
        
        .time-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-secondary);
        }
        
        .time-unit {
            font-size: var(--font-size-sm);
            color: var(--text-tertiary);
            min-width: 40px;
        }
        
        .interval-controls {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .interval-toggle {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .interval-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-primary);
        }
        
        .interval-time {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .time-select {
            padding: var(--space-1) var(--space-2);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }
        
        .time-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .actions-section {
            padding: var(--space-6);
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            margin-top: var(--space-6);
            display: flex;
            justify-content: center;
            gap: var(--space-4);
        }
        
        .status-info {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-size-sm);
        }
        
        @media (max-width: 968px) {
            .schedule-header-row,
            .schedule-row {
                grid-template-columns: 1fr;
                gap: var(--space-3);
            }
            
            .time-section {
                justify-content: space-between;
                padding: var(--space-3);
                background: var(--bg-secondary);
                border-radius: var(--radius-md);
            }
            
            .interval-controls {
                flex-wrap: wrap;
                justify-content: space-between;
            }
            
            .schedule-controls {
                flex-direction: column;
            }
            
            .quick-control {
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="dashboard-title">
                <h1>{{ user.username }} - Schedule</h1>
                <p class="dashboard-subtitle">Manage time limits and allowed intervals</p>
            </div>
            <div class="dashboard-controls">
                <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-secondary">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                    </svg>
                    Dashboard
                </a>
                <a href="{{ url_for('admin') }}" class="btn btn-sm btn-secondary">Admin</a>
                <a href="{{ url_for('settings') }}" class="btn btn-sm btn-secondary">Settings</a>
                <a href="{{ url_for('logout') }}" class="btn btn-sm btn-danger">Logout</a>
            </div>
        </header>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            {% if category == 'success' %}
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                            {% elif category == 'danger' or category == 'error' %}
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                            {% elif category == 'warning' %}
                                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                            {% else %}
                                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                            {% endif %}
                        </svg>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="schedule-main">
            <!-- Status Overview -->
            <div class="schedule-overview">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                    <div>
                        <h2 style="margin: 0;">{{ user.username }}</h2>
                        <p style="margin: 0; color: var(--text-secondary); font-family: monospace;">{{ user.system_ip }}</p>
                    </div>
                    <div class="status-info">
                        <div id="sync-status-badge" class="badge" style="display: none;">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path id="sync-status-icon" d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                            </svg>
                            <span id="sync-status-text">Changes Pending Sync</span>
                        </div>
                    </div>
                </div>
                
                {% if user.weekly_schedule %}
                    {% set schedule = user.weekly_schedule.get_schedule_dict() %}
                    {% set total_week = schedule['monday'] + schedule['tuesday'] + schedule['wednesday'] + schedule['thursday'] + schedule['friday'] %}
                    {% set total_weekend = schedule['saturday'] + schedule['sunday'] %}
                    {% set total_all = total_week + total_weekend %}
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-4);">
                        <div style="text-align: center; padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md);">
                            <div style="font-size: var(--font-size-2xl); font-weight: 700; color: var(--accent-primary);">{{ total_all }}h</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-tertiary);">Total per week</div>
                        </div>
                        <div style="text-align: center; padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md);">
                            <div style="font-size: var(--font-size-xl); font-weight: 600; color: var(--text-primary);">{{ total_week }}h</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-tertiary);">Weekdays (Mon-Fri)</div>
                        </div>
                        <div style="text-align: center; padding: var(--space-3); background: var(--bg-secondary); border-radius: var(--radius-md);">
                            <div style="font-size: var(--font-size-xl); font-weight: 600; color: var(--warning);">{{ total_weekend }}h</div>
                            <div style="font-size: var(--font-size-sm); color: var(--text-tertiary);">Weekend (Sat-Sun)</div>
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <!-- Quick Controls -->
            <div class="schedule-controls">
                <div class="quick-control">
                    <label>Quick set hours:</label>
                    <button type="button" class="btn btn-sm btn-ghost" onclick="adjustBulkTime(-0.25)">-15min</button>
                    <input type="number" id="bulk-hours" min="0" max="24" step="0.25" placeholder="2.5" class="quick-input">
                    <button type="button" class="btn btn-sm btn-ghost" onclick="adjustBulkTime(0.25)">+15min</button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="setWeekdays()">Weekdays</button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="setWeekends()">Weekends</button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="setAllDays()">All Days</button>
                </div>
                <div class="quick-control">
                    <label>Quick set interval:</label>
                    <select id="bulk-start" class="time-select">
                        {% for h in range(24) %}
                        <option value="{{ h }}" {% if h == 9 %}selected{% endif %}>{{ '%02d:00'|format(h) }}</option>
                        {% endfor %}
                    </select>
                    <span>to</span>
                    <select id="bulk-end" class="time-select">
                        {% for h in range(24) %}
                        <option value="{{ h }}" {% if h == 17 %}selected{% endif %}>{{ '%02d:00'|format(h) }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="setWeekdayIntervals()">Weekdays</button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="setWeekendIntervals()">Weekends</button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="setAllIntervals()">All Days</button>
                </div>
            </div>
            
            <!-- Schedule Table -->
            <form id="schedule-form" method="POST" action="{{ url_for('update_weekly_schedule') }}">
                <input type="hidden" name="user_id" value="{{ user.id }}">
                
                <div class="schedule-table">
                    <div class="schedule-header-row">
                        <div>Day</div>
                        <div>Daily Time Limit</div>
                        <div>Allowed Time Interval</div>
                    </div>
                    
                    {% set days = [
                        ('monday', 'Monday', 1),
                        ('tuesday', 'Tuesday', 2), 
                        ('wednesday', 'Wednesday', 3),
                        ('thursday', 'Thursday', 4),
                        ('friday', 'Friday', 5),
                        ('saturday', 'Saturday', 6),
                        ('sunday', 'Sunday', 7)
                    ] %}
                    
                    {% for day_key, day_name, day_num in days %}
                    <div class="schedule-row {% if day_num >= 6 %}weekend{% endif %}">
                        <div class="day-name">{{ day_name }}</div>
                        
                        <!-- Daily Time Limit -->
                        <div class="time-section">
                            <div class="time-controls">
                                <button type="button" class="time-btn" onclick="adjustTime('{{ day_key }}', -0.25)">−</button>
                                <input type="number" 
                                       id="{{ day_key }}" 
                                       name="{{ day_key }}" 
                                       min="0" 
                                       max="24" 
                                       step="0.25"
                                       value="{% if user.weekly_schedule %}{{ user.weekly_schedule.get_schedule_dict()[day_key] }}{% else %}0{% endif %}"
                                       class="time-input">
                                <button type="button" class="time-btn" onclick="adjustTime('{{ day_key }}', 0.25)">+</button>
                            </div>
                            <span class="time-unit">hours</span>
                        </div>
                        
                        <!-- Time Intervals -->
                        <div class="time-section">
                            <div class="interval-controls">
                                <div class="interval-toggle">
                                    <input type="checkbox" id="interval-{{ day_num }}" onchange="toggleInterval({{ day_num }})">
                                    <label for="interval-{{ day_num }}">Enable</label>
                                </div>
                                <div class="interval-time">
                                    <select id="start-{{ day_num }}" class="time-select" disabled>
                                        {% for h in range(24) %}
                                        <option value="{{ h }}">{{ '%02d:00'|format(h) }}</option>
                                        {% endfor %}
                                    </select>
                                    <span>to</span>
                                    <select id="end-{{ day_num }}" class="time-select" disabled>
                                        {% for h in range(24) %}
                                        <option value="{{ h }}">{{ '%02d:00'|format(h) }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Actions -->
                <div class="actions-section">
                    <button type="button" class="btn btn-primary btn-lg" onclick="saveAll()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M15.854 5.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L12.5 7.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                        </svg>
                        Save All Changes
                    </button>
                    <button type="button" class="btn btn-secondary btn-lg" onclick="resetForm()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                        Reset to Saved
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Notification Toast -->
    <div id="notification-toast" class="notification-toast">
        <div class="toast-content">
            <svg class="toast-icon" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </svg>
            <span class="toast-message">Changes saved successfully!</span>
        </div>
    </div>
    
    <style>
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateX(calc(100% + 20px));
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
            max-width: 300px;
        }
        
        .notification-toast.show {
            transform: translateX(0);
        }
        
        .notification-toast.success {
            border-left: 4px solid var(--success);
        }
        
        .notification-toast.error {
            border-left: 4px solid var(--danger);
        }
        
        .toast-content {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .toast-icon {
            flex-shrink: 0;
        }
        
        .notification-toast.success .toast-icon {
            color: var(--success);
        }
        
        .notification-toast.error .toast-icon {
            color: var(--danger);
        }
        
        .toast-message {
            font-weight: 500;
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }
    </style>
    
    <script>
        // Notification functions
        function showNotification(message, type = 'success') {
            const toast = document.getElementById('notification-toast');
            const messageEl = toast.querySelector('.toast-message');
            const iconEl = toast.querySelector('.toast-icon path');
            
            // Set message
            messageEl.textContent = message;
            
            // Set type and icon
            toast.className = `notification-toast ${type}`;
            if (type === 'success') {
                iconEl.setAttribute('d', 'M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z');
            } else if (type === 'error') {
                iconEl.setAttribute('d', 'M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z');
            }
            
            // Show toast
            toast.classList.add('show');
            
            // Hide after 2 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
        
        // Intervals data
        let intervals = {};
        
        // Load intervals on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadIntervals();
        });
        
        // Time adjustment functions
        function adjustTime(dayId, change) {
            const input = document.getElementById(dayId);
            let currentValue = parseFloat(input.value) || 0;
            let newValue = Math.max(0, Math.min(24, currentValue + change));
            input.value = newValue;
        }
        
        // Bulk time setting functions
        function setWeekdays() {
            const hours = document.getElementById('bulk-hours').value;
            if (!hours) return;
            ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'].forEach(day => {
                document.getElementById(day).value = hours;
            });
        }
        
        function setWeekends() {
            const hours = document.getElementById('bulk-hours').value;
            if (!hours) return;
            ['saturday', 'sunday'].forEach(day => {
                document.getElementById(day).value = hours;
            });
        }
        
        function setAllDays() {
            const hours = document.getElementById('bulk-hours').value;
            if (!hours) return;
            ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
                document.getElementById(day).value = hours;
            });
        }
        
        // Interval functions
        function toggleInterval(day) {
            const checkbox = document.getElementById(`interval-${day}`);
            const startSelect = document.getElementById(`start-${day}`);
            const endSelect = document.getElementById(`end-${day}`);
            
            startSelect.disabled = !checkbox.checked;
            endSelect.disabled = !checkbox.checked;
        }
        
        function setWeekdayIntervals() {
            const startHour = document.getElementById('bulk-start').value;
            const endHour = document.getElementById('bulk-end').value;
            
            for (let day = 1; day <= 5; day++) {
                document.getElementById(`interval-${day}`).checked = true;
                document.getElementById(`start-${day}`).value = startHour;
                document.getElementById(`end-${day}`).value = endHour;
                toggleInterval(day);
            }
        }
        
        function setWeekendIntervals() {
            const startHour = document.getElementById('bulk-start').value;
            const endHour = document.getElementById('bulk-end').value;
            
            // Apply to weekends (Saturday = 6, Sunday = 7)
            for (let day = 6; day <= 7; day++) {
                document.getElementById(`interval-${day}`).checked = true;
                document.getElementById(`start-${day}`).value = startHour;
                document.getElementById(`end-${day}`).value = endHour;
                toggleInterval(day);
            }
        }
        
        function setAllIntervals() {
            const startHour = document.getElementById('bulk-start').value;
            const endHour = document.getElementById('bulk-end').value;
            
            for (let day = 1; day <= 7; day++) {
                document.getElementById(`interval-${day}`).checked = true;
                document.getElementById(`start-${day}`).value = startHour;
                document.getElementById(`end-${day}`).value = endHour;
                toggleInterval(day);
            }
        }
        
        function loadIntervals() {
            fetch(`/api/user/{{ user.id }}/intervals`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        intervals = data.intervals;
                        for (let day = 1; day <= 7; day++) {
                            const interval = intervals[day];
                            if (interval) {
                                document.getElementById(`interval-${day}`).checked = interval.is_enabled;
                                document.getElementById(`start-${day}`).value = interval.start_hour;
                                document.getElementById(`end-${day}`).value = interval.end_hour;
                                toggleInterval(day);
                            }
                        }
                    }
                });
        }
        
        // Add bulk time adjustment function
        function adjustBulkTime(change) {
            const input = document.getElementById('bulk-hours');
            let currentValue = parseFloat(input.value) || 0;
            let newValue = Math.max(0, Math.min(24, currentValue + change));
            input.value = newValue;
        }
        
        // Combined save function for both schedule and intervals
        function saveAll() {
            // First, save the schedule by submitting the form
            const form = document.getElementById('schedule-form');
            const formData = new FormData(form);
            
            // Save schedule
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // If schedule save successful, now save intervals
                    return saveIntervals(false); // false means don't show alert yet
                } else {
                    throw new Error('Failed to save schedule');
                }
            })
            .then(() => {
                showNotification('All changes saved successfully!');
                // Update status immediately instead of reloading
                setTimeout(() => {
                    updateSyncStatus();
                }, 1000);
            })
            .catch(error => {
                showNotification('Error saving changes: ' + error.message, 'error');
            });
        }
        
        function saveIntervals(showAlert = true) {
            return new Promise((resolve, reject) => {
                const intervalData = {};
                
                for (let day = 1; day <= 7; day++) {
                    const enabled = document.getElementById(`interval-${day}`).checked;
                    const startHour = parseInt(document.getElementById(`start-${day}`).value);
                    const endHour = parseInt(document.getElementById(`end-${day}`).value);
                    
                    if (enabled && startHour >= endHour) {
                        const error = `Invalid time range for day ${day}: start time must be before end time`;
                        if (showAlert) showNotification(error, 'error');
                        reject(new Error(error));
                        return;
                    }
                    
                    intervalData[day] = {
                        is_enabled: enabled,
                        start_hour: startHour,
                        start_minute: 0,
                        end_hour: endHour,
                        end_minute: 0
                    };
                }
                
                fetch(`/api/user/{{ user.id }}/intervals/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ intervals: intervalData })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (showAlert) {
                            showNotification('Time intervals saved successfully!');
                            loadIntervals();
                        }
                        resolve();
                    } else {
                        const error = 'Error: ' + data.message;
                        if (showAlert) showNotification(error, 'error');
                        reject(new Error(data.message));
                    }
                })
                .catch(error => {
                    const errorMsg = 'Network error: ' + error.message;
                    if (showAlert) showNotification(errorMsg, 'error');
                    reject(error);
                });
            });
        }
        
        function resetForm() {
            if (confirm('Reset to last saved values?')) {
                location.reload();
            }
        }
        
        // Function to update sync status
        function updateSyncStatus() {
            fetch('/api/schedule-sync-status/{{ user.id }}')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const statusBadge = document.getElementById('sync-status-badge');
                        const statusIcon = document.getElementById('sync-status-icon');
                        const statusText = document.getElementById('sync-status-text');
                        
                        if (!data.is_synced && data.schedule) {
                            // Show "Changes Pending Sync" badge
                            statusBadge.className = 'badge badge-warning';
                            statusBadge.style.display = 'block';
                            statusIcon.setAttribute('d', 'M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z');
                            statusText.textContent = 'Changes Pending Sync';
                        } else if (data.is_synced && data.schedule) {
                            // Show "Synchronized" badge
                            statusBadge.className = 'badge badge-success';
                            statusBadge.style.display = 'block';
                            statusIcon.setAttribute('d', 'M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z');
                            statusText.textContent = 'Synchronized';
                        } else {
                            // Hide badge when no schedule
                            statusBadge.style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching sync status:', error);
                });
        }
        
        // Update sync status immediately and then every 5 seconds
        updateSyncStatus();
        setInterval(updateSyncStatus, 5000);
    </script>
</body>
</html>